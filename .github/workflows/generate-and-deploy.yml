name: Generate and Deploy Blog Content

on:
  # ðŸ• SCHEDULED RUNS - Automatic content generation
  schedule:
    # Daily at 6 AM UTC (1 AM EST, 10 PM PST)
    - cron: '0 6 * * *'
    # Optional: Add more schedules for higher frequency
    # - cron: '0 18 * * *'  # Second run at 6 PM UTC
  
  # ðŸ”˜ MANUAL TRIGGER - Run anytime from Actions tab
  workflow_dispatch:
    inputs:
      post_count:
        description: 'Number of posts to generate per blog'
        required: false
        default: '1'
        type: choice
        options:
          - '1'
          - '2'
          - '3'
      dry_run:
        description: 'Test without deploying'
        required: false
        default: false
        type: boolean

  # ðŸ“ CONFIG CHANGES - Run when config is updated
  push:
    branches:
      - main
    paths:
      - 'config/blog-network-config.json'

# ðŸ”’ Prevent concurrent runs (avoid duplicate content)
concurrency:
  group: blog-generation
  cancel-in-progress: false

env:
  NODE_VERSION: '18'
  PNPM_VERSION: '8'

jobs:
  generate-and-deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 30  # Prevent hung jobs
    
    steps:
      - name: ðŸ”„ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for better context
      
      - name: ðŸ“¦ Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}
      
      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'
      
      - name: ðŸ“š Install dependencies
        run: pnpm install --frozen-lockfile
      
      - name: ðŸ”‘ Validate API Key
        run: |
          if [ -z "${{ secrets.OPENAI_API_KEY }}" ]; then
            echo "::error::OPENAI_API_KEY secret is not set!"
            echo "Go to Settings â†’ Secrets â†’ Actions to add it."
            exit 1
          fi
          echo "âœ… API key configured"
      
      - name: ðŸ¤– Generate blog content
        id: generate
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          set -e
          POST_COUNT="${{ github.event.inputs.post_count || '1' }}"
          echo "ðŸ“ Generating $POST_COUNT post(s) per blog..."
          
          # Run with retry logic
          MAX_RETRIES=3
          RETRY_COUNT=0
          
          until node generators/openai-content-pipeline.js batch "$POST_COUNT"; do
            RETRY_COUNT=$((RETRY_COUNT + 1))
            if [ $RETRY_COUNT -ge $MAX_RETRIES ]; then
              echo "::error::Content generation failed after $MAX_RETRIES attempts"
              exit 1
            fi
            echo "âš ï¸ Attempt $RETRY_COUNT failed, retrying in 30s..."
            sleep 30
          done
          
          # Count generated content
          if [ -d "output" ]; then
            BLOG_COUNT=$(find output -maxdepth 1 -type d | tail -n +2 | wc -l)
            POST_TOTAL=$(find output -name '*.html' | wc -l)
            echo "blogs_generated=$BLOG_COUNT" >> $GITHUB_OUTPUT
            echo "posts_generated=$POST_TOTAL" >> $GITHUB_OUTPUT
          fi
      
      - name: ðŸ“Š Content Statistics
        run: |
          echo "## ðŸ“ˆ Content Generation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          
          if [ -d "output" ]; then
            BLOGS=$(find output -maxdepth 1 -type d | tail -n +2 | wc -l)
            POSTS=$(find output -name '*.html' | wc -l)
            SIZE=$(du -sh output | cut -f1)
            
            echo "| ðŸ“ Blogs | $BLOGS |" >> $GITHUB_STEP_SUMMARY
            echo "| ðŸ“„ Total Posts | $POSTS |" >> $GITHUB_STEP_SUMMARY
            echo "| ðŸ’¾ Total Size | $SIZE |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Status | No content yet |" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ• Generated: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          
          # List blogs
          echo "### ðŸ“š Blog Breakdown" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          for blog in output/*/; do
            if [ -d "$blog" ]; then
              name=$(basename "$blog")
              count=$(find "$blog" -name '*.html' | wc -l)
              echo "- **$name**: $count posts" >> $GITHUB_STEP_SUMMARY
            fi
          done
      
      - name: ðŸš€ Prepare deployment
        if: ${{ github.event.inputs.dry_run != 'true' }}
        run: |
          chmod +x scripts/deploy-production.sh
          bash scripts/deploy-production.sh
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ Deployment Package" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          find deploy/ -type f | head -30 >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
      
      - name: ðŸ“¤ Deploy to GitHub Pages
        if: ${{ github.event.inputs.dry_run != 'true' }}
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./deploy
          publish_branch: gh-pages
          cname: ${{ secrets.CUSTOM_DOMAIN }}
          force_orphan: true
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'
          commit_message: 'ðŸ¤– Auto-deploy: ${{ steps.generate.outputs.posts_generated }} posts generated'
      
      - name: âœ… Deployment Complete
        if: ${{ github.event.inputs.dry_run != 'true' }}
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸŽ‰ Deployment Successful!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -n "${{ secrets.CUSTOM_DOMAIN }}" ]; then
            echo "ðŸŒ **Live at**: https://${{ secrets.CUSTOM_DOMAIN }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "ðŸŒ **Live at**: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Next scheduled run: Check the Actions tab for schedule" >> $GITHUB_STEP_SUMMARY
      
      - name: ðŸ§ª Dry Run Complete
        if: ${{ github.event.inputs.dry_run == 'true' }}
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ§ª Dry Run Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Content was generated but NOT deployed." >> $GITHUB_STEP_SUMMARY
          echo "Run again without dry_run to deploy." >> $GITHUB_STEP_SUMMARY
